name: PR Code Reviewer

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read        # needed for checkout
  pull-requests: write  # needed to comment on PR

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install root dependencies
        run: |
          npm install -g snyk
          npm install

      - name: Install CLI dependencies
        run: |
          cd code-reviewer
          npm install

      - name: Authenticate Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }}

      - name: Verify Snyk setup
        run: snyk --version

      - name: Run Snyk scan
        run: |
          snyk test --json > snyk-report.json || echo "Snyk scan failed"
          echo "=== snyk-report.json status ==="
          ls -l snyk-report.json || echo "No snyk-report.json created"

      - name: Determine Operation Mode
        id: determine_mode
        run: |
          # Default mode if no tag is found
          MODE="loose"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          # Combine title and body and use grep/regex to find a tag like [mode:strict]
          # The regex finds 'loose', 'strict', or 'custom' inside [mode:...]
          MATCH=$(echo "$PR_TITLE$PR_BODY" | grep -oP '\[mode:\K(loose|strict|custom)(?=\])' | head -1)

          if [ ! -z "$MATCH" ]; then
              MODE="$MATCH"
          fi
          
          echo "Selected Mode: $MODE"
          # Set the mode as a step output for use in subsequent steps
          echo "mode=$MODE" >> $GITHUB_OUTPUT

      - name: Run Code Reviewer
        if: success() && hashFiles('snyk-report.json') != ''
        id: runreview
        run: |
          # Retrieve the determined mode from the previous step's output
          MODE="${{ steps.determine_mode.outputs.mode }}"
          
          # Pass the mode to your CLI script as an argument
          output=$(node code-reviewer/cli.js --path . --mode $MODE)
          
          # Set the output for the PR comment step
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload Snyk report as artifact
        if: success() && hashFiles('snyk-report.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: snyk-report
          path: snyk-report.json

      - name: Comment on PR
        if: success() && hashFiles('snyk-report.json') != ''
        uses: actions/github-script@v7
        id: pr_status_check  # <--- Give this step an ID for status checks
        with:
          script: |
            const message = `${{ steps.runreview.outputs.content }}`;
            const decision = message.includes("PR Decision: REJECT") ? "REJECT" : "APPROVE";
            
            // 1. Post the comment (as you already do)
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

            // 2. Set the result and fail the job if rejected
            if (decision === "REJECT") {
              console.log("::error::The code review decision is REJECT. Merge blocked by security policy.");
              // This is the key: set the status check to failure
              core.setFailed("PR failed automated code review.");
            }
          
          # NOTE: You must use the `actions/github-script` with the `core` library
          # To use core.setFailed, you must grant write access to the action:
          # permissions:
          #   contents: read
          #   pull-requests: write # This is already set
          #   statuses: write      # <--- ADD THIS to the permissions block if needed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Upload Snyk Code Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-code-review-report
          path: code-reviewer/snyk-code-report.txt
